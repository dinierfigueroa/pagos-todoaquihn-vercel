<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Verificación 3-D Secure</title>
  <script src="https://songbird.cardinalcommerce.com/edge/v1/songbird.js"></script>
  <style>
    body {
      font-family: system-ui, Arial, sans-serif;
      margin: 0;
      padding: 24px;
      background: #fafafa;
    }
    .card {
      max-width: 520px;
      margin: 0 auto;
      border: 1px solid #ddd;
      border-radius: 14px;
      padding: 20px;
      background: white;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .status {
      padding: 10px;
      border-radius: 8px;
      background: #f7f7f7;
      margin-top: 12px;
      word-break: break-word;
      white-space: pre-wrap;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>Verificación 3-D Secure</h2>
    <p>Estamos confirmando la autenticación con tu banco…</p>
    <div id="log" class="status">Cargando parámetros...</div>
  </div>

  <script>
    const L = (msg, obj) => {
      const el = document.getElementById('log');
      el.textContent += "\n" + msg + (obj ? " " + JSON.stringify(obj, null, 2) : "");
      console.log("[3DS]", msg, obj || "");
    };

    // 1️⃣ Obtener parámetros de la URL
    const qs = new URLSearchParams(location.search);
    const AcsUrl        = qs.get('acsUrl');
    const Payload       = qs.get('payload');
    const TransactionId = qs.get('transactionId');

    if (!AcsUrl || !Payload || !TransactionId) {
      L("❌ Faltan parámetros obligatorios (AcsUrl, Payload o TransactionId).");
      throw new Error("Parámetros incompletos en la URL.");
    }

    // 2️⃣ Configurar Cardinal
    Cardinal.configure({ logging: { level: "on" } });

    // 3️⃣ Evento principal: resultado del reto
    Cardinal.on("payments.validated", function(data, jwt) {
      L("✅ Resultado del 3DS", data);
      const result = { type:"3DS_RESULT", data, jwt };
      try { window.parent?.postMessage(JSON.stringify(result), "*"); } catch(e){}
      try { window.opener?.postMessage(JSON.stringify(result), "*"); } catch(e){}
      L("Validación finalizada. Puedes cerrar esta ventana.");
    });

    // 4️⃣ Lanzar el reto (challenge)
    try {
      L("Iniciando reto 3-D Secure...");
      Cardinal.continue("cca", { AcsUrl, Payload, TransactionId }, {});
    } catch (e) {
      L("Error al iniciar Cardinal.continue:", e);
    }
  </script>
</body>
</html>