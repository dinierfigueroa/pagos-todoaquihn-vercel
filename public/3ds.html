<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Verificación 3-D Secure</title>
  <script src="https://songbird.cardinalcommerce.com/edge/v1/songbird.js"></script>
  <style>
    body{font-family:system-ui,Arial;margin:0;padding:24px;background:#fafafa}
    .card{max-width:560px;margin:0 auto;border:1px solid #ddd;border-radius:14px;padding:20px;background:#fff;box-shadow:0 4px 10px rgba(0,0,0,.05)}
    .muted{color:#777;font-size:13px}
    .status{padding:10px;border-radius:8px;background:#f7f7f7;margin-top:12px;white-space:pre-wrap;word-break:break-word;font-family:ui-monospace,Consolas,monospace;font-size:13px}
  </style>
</head>
<body>
  <div class="card">
    <h2>Verificación 3-D Secure</h2>
    <p class="muted">Estamos confirmando la autenticación con tu banco…</p>
    <div id="log" class="status">Cargando…</div>
  </div>

  <script>
    const logEl = document.getElementById('log');
    const L = (m,o)=>{ logEl.textContent += "\n"+m+(o?" "+JSON.stringify(o,null,2):""); console.log("[3DS]", m, o||""); };

    // Recibe ?token=<JWT>&uuid=<payment_uuid>
    const qs = new URLSearchParams(location.search);
    const TOKEN = qs.get('token');
    if (!TOKEN) { L("❌ Falta ?token (JWT)."); throw new Error("Missing JWT"); }

    // Configurar
    Cardinal.configure({ logging: { level: "on" } });

    // Resultado
    Cardinal.on("payments.validated", function (data, jwt) {
      L("✅ payments.validated", data);
      const result = { type:"3DS_RESULT", data, jwt };
      try { window.parent?.postMessage(JSON.stringify(result), "*"); } catch(e){}
      try { window.opener?.postMessage(JSON.stringify(result), "*"); } catch(e){}
      L("Validación finalizada. Puedes cerrar esta ventana.");
    });

    // Flujo JWT (songbird): setup + start
    Cardinal.on("payments.setupComplete", function(data){
      L("payments.setupComplete", data);
      try {
        // ¡IMPORTANTE! Aquí va en MAYÚSCULAS: JWT
        Cardinal.start("cca", { JWT: TOKEN });
        L("start('cca') lanzado con JWT");
      } catch (e) { L("Error start:", e?.message || e); }
    });

    try {
      // En setup el campo es en minúsculas: jwt
      Cardinal.setup("init", { jwt: TOKEN });
      L("setup('init') enviado con jwt");
    } catch (e) { L("Error setup:", e?.message || e); }
  </script>
</body>
</html>